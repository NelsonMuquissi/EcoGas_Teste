{% extends 'base.html' %}

{% block title %}Entregas{% endblock %}
{% block page_title %}Gestão de Entregas{% endblock %}
{% block page_subtitle %}Monitoramento e gestão de entregas em tempo real{% endblock %}

{% block content %}
<!-- Filtros e Estatísticas -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card card-modern">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Buscar pedido, cliente..." id="searchInput">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">Todos os status</option>
                            <option value="pending">Pendentes</option>
                            <option value="accepted">Aceitas</option>
                            <option value="on_route">Em Rota</option>
                            <option value="delivered">Entregues</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="deliveryPersonFilter">
                            <option value="">Todos os entregadores</option>
                            <option value="joao">João Silva</option>
                            <option value="maria">Maria Santos</option>
                            <option value="carlos">Carlos Oliveira</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-1"></i>Filtrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-modern">
            <div class="card-body py-3">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="border-end">
                            <div class="fw-bold fs-4 text-primary" id="totalDeliveries">0</div>
                            <small class="text-muted">Total</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border-end">
                            <div class="fw-bold fs-4 text-warning" id="activeDeliveries">0</div>
                            <small class="text-muted">Ativas</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold fs-4 text-success" id="completedDeliveries">0</div>
                        <small class="text-muted">Concluídas</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mapa em Tempo Real -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card card-modern">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-map-marker-alt me-2"></i>Monitoramento em Tempo Real
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshMap()">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="showAllDeliveries()">
                            <i class="fas fa-eye me-1"></i>Ver Todas
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="map-container" id="mapContainer">
                    <div class="map-placeholder">
                        <i class="fas fa-map-marked-alt fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Mapa de Entregas</h5>
                        <p class="text-muted mb-3">Monitoramento em tempo real das entregas ativas</p>
                        <div class="delivery-markers">
                            <div class="delivery-marker active" data-delivery="1">
                                <div class="marker-pulse"></div>
                                <div class="marker-icon">
                                    <i class="fas fa-truck"></i>
                                </div>
                            </div>
                            <div class="delivery-marker on-route" data-delivery="2">
                                <div class="marker-pulse"></div>
                                <div class="marker-icon">
                                    <i class="fas fa-motorcycle"></i>
                                </div>
                            </div>
                            <div class="delivery-marker pending" data-delivery="3">
                                <div class="marker-pulse"></div>
                                <div class="marker-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Lista de Entregas -->
    <div class="col-lg-8 mb-4">
        <div class="card card-modern">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-list me-2"></i>Todas as Entregas
                    </h5>
                    <span class="badge bg-primary badge-modern" id="deliveriesCount">0 entregas</span>
                </div>
            </div>
            <div class="card-body p-0">
                {% if deliveries %}
                <div class="table-responsive">
                    <table class="table table-modern table-hover mb-0" id="deliveriesTable">
                        <thead>
                            <tr>
                                <th class="ps-4">Pedido</th>
                                <th>Cliente</th>
                                <th>Entregador</th>
                                <th>Localização</th>
                                <th>Status</th>
                                <th>Tempo</th>
                                <th class="text-end pe-4">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for delivery in deliveries %}
                            <tr class="delivery-row" data-status="{{ delivery.status }}" data-delivery-person="{{ delivery.delivery_person }}">
                                <td class="ps-4">
                                    <div class="fw-bold text-primary">#{{ delivery.order.id|slice:":8" }}</div>
                                    <small class="text-muted">{{ delivery.order.created_at|date:"d/m H:i" }}</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-light rounded-circle me-2 d-flex align-items-center justify-content-center">
                                            <i class="fas fa-user text-muted"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">{{ delivery.order.customer_name }}</div>
                                            <small class="text-muted">{{ delivery.order.customer_phone }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if delivery.delivery_person %}
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-info rounded-circle me-2 d-flex align-items-center justify-content-center text-white">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">{{ delivery.delivery_person.name }}</div>
                                            <small class="text-muted">{{ delivery.delivery_person.phone }}</small>
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">Não atribuído</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="text-nowrap">
                                        <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                        {% if delivery.current_location %}
                                        <small class="text-muted">Rastreando...</small>
                                        {% else %}
                                        <small class="text-muted">Aguardando</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <form method="post" action="{% url 'update_delivery_status' delivery.id %}" class="status-form">
                                        {% csrf_token %}
                                        <select name="status" class="form-select status-select" 
                                                data-delivery-id="{{ delivery.id }}" 
                                                onchange="updateDeliveryStatus(this)">
                                            <option value="pending" {% if delivery.status == 'pending' %}selected{% endif %}>Pendente</option>
                                            <option value="accepted" {% if delivery.status == 'accepted' %}selected{% endif %}>Aceita</option>
                                            <option value="on_route" {% if delivery.status == 'on_route' %}selected{% endif %}>Em Rota</option>
                                            <option value="delivered" {% if delivery.status == 'delivered' %}selected{% endif %}>Entregue</option>
                                        </select>
                                    </form>
                                </td>
                                <td>
                                    <div class="delivery-timer" data-created="{{ delivery.created_at|date:'U' }}">
                                        <small class="text-muted">--:--</small>
                                    </div>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewDeliveryDetails('{{ delivery.id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="trackDelivery('{{ delivery.id }}')">
                                            <i class="fas fa-map-marked-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-success" onclick="contactDeliveryPerson('{{ delivery.delivery_person.phone }}')">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-truck fa-3x text-muted opacity-50"></i>
                    </div>
                    <h5 class="text-muted">Nenhuma entrega encontrada</h5>
                    <p class="text-muted mb-0">As entregas aparecerão aqui automaticamente</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Painel de Controle -->
    <div class="col-lg-4 mb-4">
        <!-- Entregas Ativas -->
        <div class="card card-modern mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0 text-primary">
                    <i class="fas fa-truck-fast me-2"></i>Entregas Ativas
                </h5>
            </div>
            <div class="card-body">
                <div class="active-deliveries-list" id="activeDeliveriesList">
                    <!-- As entregas ativas serão carregadas via JavaScript -->
                    <div class="text-center py-3">
                        <i class="fas fa-truck-loading fa-2x text-muted mb-2"></i>
                        <p class="text-muted small">Carregando entregas ativas...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estatísticas de Performance -->
        <div class="card card-modern mb-4">
            <div class="card-body">
                <h6 class="card-title text-primary mb-3">
                    <i class="fas fa-chart-line me-2"></i>Performance
                </h6>
                <div class="performance-metrics">
                    <div class="metric-item">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Tempo Médio</span>
                            <span class="fw-bold text-primary">45min</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-primary" style="width: 75%"></div>
                        </div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Taxa de Sucesso</span>
                            <span class="fw-bold text-success">94.5%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" style="width: 94.5%"></div>
                        </div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Feedback Positivo</span>
                            <span class="fw-bold text-info">96%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-info" style="width: 96%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="card card-modern">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="card-title mb-0 text-primary">
                    <i class="fas fa-bolt me-2"></i>Ações Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="assignAllPending()">
                        <i class="fas fa-user-plus me-2"></i>Atribuir Pendentes
                    </button>
                    <button class="btn btn-outline-success" onclick="generateDeliveryReport()">
                        <i class="fas fa-file-pdf me-2"></i>Relatório de Entregas
                    </button>
                    <button class="btn btn-outline-info" onclick="refreshLiveData()">
                        <i class="fas fa-sync-alt me-2"></i>Atualizar Dados
                    </button>
                    <button class="btn btn-outline-warning" onclick="showDeliveryAnalytics()">
                        <i class="fas fa-chart-bar me-2"></i>Análises
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalhes da Entrega -->
<div class="modal fade" id="deliveryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Entrega</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deliveryModalBody">
                <!-- Conteúdo carregado via JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* Mapa de Entregas */
    .map-container {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-radius: 12px;
        height: 300px;
        position: relative;
        overflow: hidden;
        border: 2px dashed #bdbdbd;
    }
    
    .map-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #757575;
    }
    
    .delivery-markers {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    
    .delivery-marker {
        position: absolute;
        transform: translate(-50%, -50%);
    }
    
    .delivery-marker.active { top: 40%; left: 30%; }
    .delivery-marker.on-route { top: 60%; left: 60%; }
    .delivery-marker.pending { top: 30%; left: 70%; }
    
    .marker-pulse {
        width: 20px;
        height: 20px;
        background: rgba(76, 175, 80, 0.6);
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: pulse 2s infinite;
    }
    
    .delivery-marker.on-route .marker-pulse {
        background: rgba(255, 152, 0, 0.6);
    }
    
    .delivery-marker.pending .marker-pulse {
        background: rgba(244, 67, 54, 0.6);
    }
    
    .marker-icon {
        width: 30px;
        height: 30px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        position: relative;
        z-index: 2;
        font-size: 0.8rem;
    }
    
    .delivery-marker.active .marker-icon {
        color: #4caf50;
        border: 2px solid #4caf50;
    }
    
    .delivery-marker.on-route .marker-icon {
        color: #ff9800;
        border: 2px solid #ff9800;
    }
    
    .delivery-marker.pending .marker-icon {
        color: #f44336;
        border: 2px solid #f44336;
    }
    
    @keyframes pulse {
        0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
    }
    
    /* Lista de Entregas Ativas */
    .active-deliveries-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .active-delivery-item {
        padding: 12px;
        border-radius: 8px;
        background: #f8f9fa;
        margin-bottom: 10px;
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }
    
    .active-delivery-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }
    
    .active-delivery-item.success {
        border-left-color: #28a745;
    }
    
    .active-delivery-item.warning {
        border-left-color: #ffc107;
    }
    
    .active-delivery-item.danger {
        border-left-color: #dc3545;
    }
    
    .delivery-info h6 {
        margin-bottom: 5px;
        font-weight: 600;
    }
    
    .delivery-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .delivery-status {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 600;
    }
    
    /* Performance Metrics */
    .performance-metrics {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .metric-item {
        flex-grow: 1;
    }
    
    /* Timer de Entrega */
    .delivery-timer {
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
        .map-container {
            height: 200px;
        }
        
        .delivery-marker {
            transform: translate(-50%, -50%) scale(0.8);
        }
        
        .table-responsive {
            font-size: 0.875rem;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.4rem;
        }
    }
    
    @media (max-width: 576px) {
        .col-md-8, .col-md-4 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        .map-container {
            height: 150px;
        }
        
        .delivery-marker {
            transform: translate(-50%, -50%) scale(0.6);
        }
    }
</style>

<script>
    // Dados de exemplo para entregas
    const sampleDeliveries = [
        {
            id: '1',
            order: { id: '284756', customer_name: 'Maria Silva', customer_phone: '+244 923 456 789', created_at: new Date(Date.now() - 30 * 60000) },
            delivery_person: { name: 'João Silva', phone: '+244 912 345 678' },
            status: 'on_route',
            current_location: { lat: -8.8383, lng: 13.2344 },
            address: 'Rua dos Combatentes, 123 - Luanda'
        },
        {
            id: '2',
            order: { id: '284757', customer_name: 'Carlos Santos', customer_phone: '+244 934 567 890', created_at: new Date(Date.now() - 45 * 60000) },
            delivery_person: { name: 'Maria Fernandes', phone: '+244 922 333 444' },
            status: 'accepted',
            current_location: null,
            address: 'Avenida 4 de Fevereiro, 456 - Luanda'
        },
        {
            id: '3',
            order: { id: '284758', customer_name: 'Ana Oliveira', customer_phone: '+244 945 678 901', created_at: new Date(Date.now() - 15 * 60000) },
            delivery_person: null,
            status: 'pending',
            current_location: null,
            address: 'Rua da Missão, 789 - Luanda'
        }
    ];

    // Inicializar a página de entregas
    function initializeDeliveries() {
        updateDeliveryStats();
        loadActiveDeliveries();
        startTimers();
        setupEventListeners();
    }

    // Atualizar estatísticas
    function updateDeliveryStats() {
        const total = document.querySelectorAll('.delivery-row').length;
        const active = document.querySelectorAll('.delivery-row[data-status="on_route"]').length;
        const completed = document.querySelectorAll('.delivery-row[data-status="delivered"]').length;
        
        document.getElementById('totalDeliveries').textContent = total;
        document.getElementById('activeDeliveries').textContent = active;
        document.getElementById('completedDeliveries').textContent = completed;
        document.getElementById('deliveriesCount').textContent = `${total} entregas`;
    }

    // Carregar entregas ativas
    function loadActiveDeliveries() {
        const container = document.getElementById('activeDeliveriesList');
        const activeDeliveries = sampleDeliveries.filter(d => d.status === 'on_route' || d.status === 'accepted');
        
        if (activeDeliveries.length === 0) {
            container.innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-truck fa-2x text-muted mb-2"></i>
                    <p class="text-muted small">Nenhuma entrega ativa no momento</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = activeDeliveries.map(delivery => `
            <div class="active-delivery-item ${getStatusClass(delivery.status)}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="delivery-info flex-grow-1">
                        <h6 class="mb-1">#${delivery.order.id}</h6>
                        <div class="delivery-meta mb-1">
                            <i class="fas fa-user me-1"></i> ${delivery.order.customer_name}
                        </div>
                        <div class="delivery-meta">
                            <i class="fas fa-map-marker-alt me-1"></i> ${delivery.address.split(' - ')[0]}
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="delivery-status badge ${getStatusBadgeClass(delivery.status)}">
                            ${getStatusText(delivery.status)}
                        </span>
                        <div class="mt-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="trackDelivery('${delivery.id}')">
                                <i class="fas fa-map"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Funções auxiliares para status
    function getStatusClass(status) {
        const classes = {
            'pending': 'warning',
            'accepted': 'info',
            'on_route': 'success',
            'delivered': 'secondary'
        };
        return classes[status] || 'secondary';
    }

    function getStatusBadgeClass(status) {
        const classes = {
            'pending': 'bg-warning',
            'accepted': 'bg-info',
            'on_route': 'bg-success',
            'delivered': 'bg-secondary'
        };
        return classes[status] || 'bg-secondary';
    }

    function getStatusText(status) {
        const texts = {
            'pending': 'Pendente',
            'accepted': 'Aceita',
            'on_route': 'Em Rota',
            'delivered': 'Entregue'
        };
        return texts[status] || status;
    }

    // Timers para entregas
    function startTimers() {
        document.querySelectorAll('.delivery-timer').forEach(timer => {
            const created = parseInt(timer.getAttribute('data-created'));
            updateTimer(timer, created);
        });
        
        setInterval(() => {
            document.querySelectorAll('.delivery-timer').forEach(timer => {
                const created = parseInt(timer.getAttribute('data-created'));
                updateTimer(timer, created);
            });
        }, 60000);
    }

    function updateTimer(timerElement, createdTimestamp) {
        const now = Math.floor(Date.now() / 1000);
        const diff = now - createdTimestamp;
        const hours = Math.floor(diff / 3600);
        const minutes = Math.floor((diff % 3600) / 60);
        
        let text = '';
        if (hours > 0) {
            text = `${hours}h ${minutes}m`;
        } else {
            text = `${minutes}m`;
        }
        
        timerElement.innerHTML = `<small class="text-muted">${text}</small>`;
    }

    // Filtros
    function applyFilters() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const deliveryPersonFilter = document.getElementById('deliveryPersonFilter').value;
        
        document.querySelectorAll('.delivery-row').forEach(row => {
            const orderId = row.querySelector('.fw-bold').textContent.toLowerCase();
            const customerName = row.querySelector('.fw-semibold').textContent.toLowerCase();
            const status = row.getAttribute('data-status');
            const deliveryPerson = row.getAttribute('data-delivery-person');
            
            let show = true;
            
            if (searchText && !orderId.includes(searchText) && !customerName.includes(searchText)) {
                show = false;
            }
            
            if (statusFilter && status !== statusFilter) {
                show = false;
            }
            
            if (deliveryPersonFilter && deliveryPerson !== deliveryPersonFilter) {
                show = false;
            }
            
            row.style.display = show ? '' : 'none';
        });
        
        updateDeliveryStats();
    }

    // Atualizar status da entrega
    function updateDeliveryStatus(selectElement) {
        const deliveryId = selectElement.getAttribute('data-delivery-id');
        const newStatus = selectElement.value;
        
        // Mostrar loading
        const originalText = selectElement.innerHTML;
        selectElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        selectElement.disabled = true;
        
        // Simular requisição à API
        setTimeout(() => {
            // Atualizar visualmente
            const row = selectElement.closest('.delivery-row');
            row.setAttribute('data-status', newStatus);
            
            // Atualizar estatísticas
            updateDeliveryStats();
            loadActiveDeliveries();
            
            // Mostrar mensagem de sucesso
            showNotification(`Status da entrega atualizado para: ${getStatusText(newStatus)}`, 'success');
            
            // Restaurar select
            selectElement.innerHTML = originalText;
            selectElement.disabled = false;
        }, 1000);
    }

    // Funções de ação
    function viewDeliveryDetails(deliveryId) {
        const delivery = sampleDeliveries.find(d => d.id === deliveryId) || sampleDeliveries[0];
        
        const modalBody = document.getElementById('deliveryModalBody');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Informações do Pedido</h6>
                    <p><strong>ID:</strong> #${delivery.order.id}</p>
                    <p><strong>Cliente:</strong> ${delivery.order.customer_name}</p>
                    <p><strong>Contacto:</strong> ${delivery.order.customer_phone}</p>
                    <p><strong>Endereço:</strong> ${delivery.address}</p>
                </div>
                <div class="col-md-6">
                    <h6>Informações da Entrega</h6>
                    <p><strong>Entregador:</strong> ${delivery.delivery_person ? delivery.delivery_person.name : 'Não atribuído'}</p>
                    <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(delivery.status)}">${getStatusText(delivery.status)}</span></p>
                    <p><strong>Contacto Entregador:</strong> ${delivery.delivery_person ? delivery.delivery_person.phone : 'N/A'}</p>
                </div>
            </div>
            <div class="mt-3">
                <h6>Histórico de Localização</h6>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    ${delivery.current_location ? 'Rastreamento ativo - Localização disponível' : 'Aguardando início do rastreamento'}
                </div>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('deliveryModal')).show();
    }

    function trackDelivery(deliveryId) {
        showNotification(`Iniciando rastreamento da entrega #${deliveryId}`, 'info');
        // Em implementação real, abriria o mapa com a localização
    }

    function contactDeliveryPerson(phone) {
        if (phone && phone !== 'N/A') {
            window.open(`tel:${phone}`, '_self');
        } else {
            showNotification('Número de telefone não disponível', 'warning');
        }
    }

    function refreshMap() {
        showNotification('Mapa atualizado com sucesso', 'success');
        // Em implementação real, atualizaria as localizações
    }

    function showAllDeliveries() {
        document.getElementById('statusFilter').value = '';
        applyFilters();
        showNotification('Mostrando todas as entregas', 'info');
    }

    function assignAllPending() {
        showNotification('Atribuindo entregas pendentes aos entregadores...', 'info');
        // Em implementação real, faria a atribuição automática
    }

    function generateDeliveryReport() {
        showNotification('Gerando relatório de entregas...', 'info');
        // Em implementação real, geraria e baixaria o relatório
    }

    function refreshLiveData() {
        showNotification('Dados atualizados com sucesso', 'success');
        updateDeliveryStats();
        loadActiveDeliveries();
    }

    function showDeliveryAnalytics() {
        showNotification('Abrindo análises de entregas...', 'info');
        // Em implementação real, abriria página de análises
    }

    // Configurar event listeners
    function setupEventListeners() {
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('deliveryPersonFilter').addEventListener('change', applyFilters);
    }

    // Inicializar quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        initializeDeliveries();
    });

    // Função de notificação
    function showNotification(message, type = 'info') {
        // Implementação simples de notificação
        console.log(`${type.toUpperCase()}: ${message}`);
        
        // Poderia usar uma biblioteca de notificações como Toastify.js
        if (typeof window.showNotification === 'function') {
            window.showNotification(message, type);
        }
    }
</script>
{% endblock %}